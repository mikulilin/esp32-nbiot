<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 GPS 轨迹显示</title>
<script src="https://webapi.amap.com/maps?v=2.0&key=99aaad9da054b71f551fb168b5a88088"></script>
<style>
  html, body { height:100%; margin:0; }
  #mapContainer { width:100%; height:100%; }
  #controls {
    position: absolute;
    top: 10px; left: 10px;
    background: rgba(255,255,255,0.9);
    padding: 10px; border-radius:5px;
    z-index: 999;
  }
  #controls div { margin-bottom:5px; }
  button { margin-right:5px; }
</style>
</head>
<body>
<div id="mapContainer"></div>
<div id="controls">
  <div id="status">状态: 未连接</div>
  <div id="longitude">经度: --</div>
  <div id="latitude">纬度: --</div>
  <div id="time">时间: --</div>
  <button id="connectBtn">连接 ESP32</button>
  <button id="disconnectBtn">断开连接</button>
  <button id="simulateBtn">开始模拟</button>
  <button onclick="clearPath()">清除轨迹</button>
</div>

<script>
const defaultPos = [108.073, 34.280];
let path = [];
let simulating = false;
let connected = false;
let following = false;
let intervalId = null;
let markers = [];

const map = new AMap.Map('mapContainer', { zoom:16, center:defaultPos });
const marker = new AMap.Marker({ position:defaultPos, map:map });
const polyline = new AMap.Polyline({ path:[defaultPos], strokeColor:"#FF0000", strokeWeight:4, map:map });

const statusDiv = document.getElementById('status');
const connectBtn = document.getElementById('connectBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const simulateBtn = document.getElementById('simulateBtn');

// 清除轨迹和标记
function clearPath() {
    path = [];
    polyline.setPath([defaultPos]);
    marker.setPosition(defaultPos);
    map.setCenter(defaultPos);
    markers.forEach(m => m.setMap(null));
    markers = [];
}

// 模拟按钮逻辑
simulateBtn.onclick = () => {
    simulating = !simulating;
    simulateBtn.innerText = simulating ? "停止模拟" : "开始模拟";
    if (simulating) {
        connected = false;
        following = false;
        statusDiv.innerText = "状态: 模拟中";
        if (intervalId) clearInterval(intervalId);
        intervalId = setInterval(simulateMove, 1000); // 每秒更新模拟点
    } else {
        if (intervalId) { clearInterval(intervalId); intervalId = null; }
        marker.setPosition(defaultPos);
        map.setCenter(defaultPos);
        path = [];
        markers.forEach(m => m.setMap(null));
        markers = [];
    }
}

// ESP32 连接按钮
connectBtn.onclick = async () => {
    if (simulating) return; // 模拟模式下不连接 ESP32

    try {
        const latest = await fetchLatestGPS();
        if (!latest) {
            connected = false;
            following = false;
            statusDiv.innerText = "状态: 未连接（ESP32 未上传数据）";
            return;
        }
        connected = true;
        following = true;
        statusDiv.innerText = "状态: 已连接 ESP32";
        path = [[latest.lon, latest.lat]]; // 最新点为起点
        updateMarker(latest);

        if (intervalId) clearInterval(intervalId);
        intervalId = setInterval(async () => {
            const gps = await fetchLatestGPS();
            if (gps) updateMarker(gps);
        }, 5000);

    } catch(e) {
        connected = false;
        following = false;
        statusDiv.innerText = "状态: 连接失败";
        console.error(e);
    }
}

// 断开连接
disconnectBtn.onclick = () => {
    following = false;
    connected = false;
    statusDiv.innerText = "状态: 已断开连接";
    if (intervalId) { clearInterval(intervalId); intervalId = null; }
}

// 获取最新 GPS 数据
async function fetchLatestGPS() {
    try {
        const res = await fetch('/api/gps');
        if (!res.ok) return null;
        const data = await res.json();
        if (!data.gps || data.gps.length === 0) return null;
        return data.gps[0]; // 最新点
    } catch (e) {
        console.warn("获取ESP32数据失败:", e);
        return null;
    }
}

// 更新地图标记和轨迹
function updateMarker(gps) {
    const pos = [parseFloat(gps.lon), parseFloat(gps.lat)];
    path.push(pos);
    polyline.setPath(path);

    // 更新主标记位置
    marker.setPosition(pos);
    map.setCenter(pos);

    // 添加独立标记，鼠标悬停显示时间
    const pointMarker = new AMap.Marker({
        position: pos,
        map: map,
        title: `时间: ${gps.time}`,
        icon: new AMap.Icon({
            size: new AMap.Size(8,8),
            image:'https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png',
            imageSize: new AMap.Size(8,8)
        })
    });
    const infoWindow = new AMap.InfoWindow({ content: `时间: ${gps.time}`, offset: new AMap.Pixel(0, -10) });
    pointMarker.on('mouseover', () => infoWindow.open(map, pos));
    markers.push(pointMarker);

    // 更新信息面板
    document.getElementById('longitude').innerText = `经度: ${pos[0].toFixed(6)}`;
    document.getElementById('latitude').innerText = `纬度: ${pos[1].toFixed(6)}`;
    document.getElementById('time').innerText = `时间: ${gps.time}`;
}

// 模拟移动函数
function simulateMove() {
    const lastPos = path.length ? path[path.length-1] : defaultPos;
    const delta = 0.0005;
    const simPos = {
        lon: lastPos[0] + (Math.random()-0.5)*delta,
        lat: lastPos[1] + (Math.random()-0.5)*delta,
        time: new Date().toISOString()
    };
    updateMarker(simPos);
}
</script>
</body>
</html>
