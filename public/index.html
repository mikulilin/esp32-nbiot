<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS 轨迹显示</title>
    <style>
        #mapContainer { width: 100%; height: 100vh; }
    </style>
    <!-- 高德地图 JS API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=99aaad9da054b71f551fb168b5a88088"></script>
</head>
<body>
    <div id="mapContainer"></div>
    <script>
        async function fetchGPSData() {
            const res = await fetch('/api/gps');
            const data = await res.json();
            return data.gps;
        }

        async function initMap() {
            const gpsData = await fetchGPSData();

            if (!gpsData || gpsData.length === 0) {
                alert('没有 GPS 数据');
                return;
            }

            // 最新点
            const latest = gpsData[0];

            // 初始化地图
            const map = new AMap.Map('mapContainer', {
                center: [latest.lon, latest.lat],
                zoom: 15
            });

            // 最新点标记
            new AMap.Marker({
                position: [latest.lon, latest.lat],
                map,
                title: `最新位置: ${latest.time}`
            });

            // 绘制轨迹
            const path = gpsData.map(item => [item.lon, item.lat]).reverse();
            const polyline = new AMap.Polyline({
                path: path,
                borderWeight: 2,
                strokeColor: '#FF33FF',
                strokeOpacity: 0.8,
                strokeWeight: 4,
                lineJoin: 'round'
            });
            map.add(polyline);

            // 调整视野显示所有轨迹点
            map.setFitView();
        }

        initMap();
        // 每隔30秒刷新
        setInterval(initMap, 30000);
    </script>
</body>
</html>

